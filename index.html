<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trueline Go</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden; /* Prevent scrollbars */
        }
        #video-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: -2;
        }
        .video-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: -1;
        }
        #map {
            height: 350px;
            width: 100%;
            border-radius: 0.75rem;
            border: 1px solid rgb(75 85 99);
        }
        input[type="datetime-local"] {
            color-scheme: dark;
        }
        /* Style for clickable car cards */
        .car-card:not(.unavailable) {
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-black text-white">

    <video id="video-background" autoplay muted loop poster="https://placehold.co/1920x1080/000000/FFFFFF?text=Loading+Video...">
        <source src="background.mp4" type="video/mp4">
        Your browser does not support the video tag.
    </video>
    <div class="video-overlay"></div>

    <div class="relative min-h-screen flex flex-col items-center justify-center p-4 z-10">
        <div id="form-view" class="w-full max-w-lg">
            <div class="p-8 bg-black bg-opacity-70 rounded-2xl shadow-2xl backdrop-blur-md border border-gray-700">
                <h1 class="text-3xl md:text-4xl font-bold text-center mb-2 text-white">Trueline Go</h1>
                <p class="text-center text-gray-300 mb-8">Reliable Rides, Anytime, Anywhere.</p>

                <div class="space-y-6">
                    <div>
                        <label for="pickup" class="block text-sm font-medium text-gray-200 mb-2">Pick Up Point</label>
                        <div class="relative flex items-center">
                            <input type="text" id="pickup" name="pickup" class="w-full px-4 py-3 bg-gray-800 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter address, postcode, or place">
                            <button id="current-location-btn" title="Use Current Location" class="absolute right-3 p-1 text-gray-400 hover:text-white transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10zm0-7a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/></svg>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label for="dropoff" class="block text-sm font-medium text-gray-200 mb-2">Drop Off Point</label>
                        <input type="text" id="dropoff" name="dropoff" class="w-full px-4 py-3 bg-gray-800 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter address, postcode, or place">
                    </div>
                    <div>
                        <label for="booking-time" class="block text-sm font-medium text-gray-200 mb-2">Booking Time</label>
                        <input type="datetime-local" id="booking-time" name="booking-time" class="w-full px-4 py-3 bg-gray-800 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <!-- Policy Checkbox and Link -->
                    <div class="flex items-center">
                        <input type="checkbox" id="policy-agreement" name="policy-agreement" class="h-4 w-4 text-blue-600 bg-gray-800 border-gray-600 rounded focus:ring-blue-500">
                        <label for="policy-agreement" class="ml-2 text-sm text-gray-200">
                            I agree to the <a href="/public/Ride_Booking_Policy.pdf" target="_blank" class="text-blue-400 hover:underline">Ride Booking Policy</a>
                        </label>
                    </div>
                </div>
                <button id="calculate-btn" class="w-full mt-8 py-3 px-4 bg-gray-500 rounded-lg text-white font-semibold text-lg shadow-lg transform cursor-not-allowed" disabled>Submit</button>
                <div id="result" class="mt-8 text-center text-lg h-8"></div>
            </div>
        </div>

        <div id="results-view" class="w-full max-w-3xl hidden">
             <div class="p-8 bg-black bg-opacity-80 rounded-2xl shadow-2xl backdrop-blur-md border border-gray-700">
                <div class="flex justify-between items-start text-center mb-6">
                    <div class="w-2/5"><h3 class="text-lg font-bold text-yellow-400">Pick Up</h3><p id="pickup-result" class="mt-1 text-gray-200"></p></div>
                    <div class="w-1/5">
                        <h3 class="text-lg font-bold text-green-400">Booking Details</h3>
                        <p id="booking-time-result" class="mt-1 text-gray-200 text-sm"></p>
                        <p id="distance-result" class="mt-2 text-gray-100 text-xl font-semibold"></p>
                    </div>
                    <div class="w-2/5"><h3 class="text-lg font-bold text-blue-400">Drop Off</h3><p id="dropoff-result" class="mt-1 text-gray-200"></p></div>
                </div>
                <div id="map"></div>
                <div class="flex space-x-4 mt-6">
                    <button id="start-over-btn" class="w-1/2 py-3 px-4 bg-gray-600 hover:bg-gray-700 rounded-lg text-white font-semibold">Start Over</button>
                    <button id="choose-vehicle-btn" class="w-1/2 py-3 px-4 bg-green-600 hover:bg-green-700 rounded-lg text-white font-semibold">Next</button>
                </div>
             </div>
        </div>

        <div id="car-selection-view" class="w-full max-w-3xl hidden">
             <div class="p-8 bg-black bg-opacity-80 rounded-2xl shadow-2xl backdrop-blur-md border border-gray-700">
                <h2 class="text-3xl font-bold text-center mb-6 text-white">Select a Ride</h2>
                <div id="car-options-container" class="space-y-4"></div>
                <div class="flex space-x-4 mt-8">
                    <button id="back-to-route-btn" class="w-1/3 py-3 px-4 bg-gray-600 hover:bg-gray-700 rounded-lg text-white font-semibold">Back</button>
                    <button id="proceed-to-booking-btn" class="w-2/3 py-3 px-4 bg-gray-500 rounded-lg text-white font-semibold cursor-not-allowed" disabled>Proceed to Booking</button>
                </div>
             </div>
        </div>

        <div id="booking-form-view" class="w-full max-w-3xl hidden">
            <div id="booking-form-container" class="p-8 bg-black bg-opacity-80 rounded-2xl shadow-2xl backdrop-blur-md border border-gray-700">
                <h2 class="text-3xl font-bold text-center mb-6 text-white">Confirm Your Booking</h2>
                
                <div class="mb-6 p-4 bg-gray-800 rounded-lg border border-gray-700 space-y-2">
                    <h3 class="text-lg font-bold text-green-400 border-b border-gray-600 pb-2 mb-2">Trip Summary</h3>
                    <p><strong>From:</strong> <span id="confirm-pickup" class="text-gray-300"></span></p>
                    <p><strong>To:</strong> <span id="confirm-dropoff" class="text-gray-300"></span></p>
                    <p><strong>When:</strong> <span id="confirm-time" class="text-gray-300"></span></p>
                    <div>
                        <p class="font-semibold"><strong>Vehicle:</strong> <span id="confirm-vehicle" class="font-semibold text-white"></span></p>
                        <p id="confirm-capacity" class="text-sm text-gray-300 mt-1"></p>
                    </div>
                    <p><strong>Price:</strong> <span id="confirm-price" class="font-bold text-xl text-yellow-400"></span></p>
                </div>

                <div class="space-y-4">
                    <div>
                        <label for="full-name" class="block text-sm font-medium text-gray-200 mb-2">Full Name</label>
                        <input type="text" id="full-name" name="full-name" class="w-full px-4 py-3 bg-gray-800 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter your full name">
                    </div>
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-200 mb-2">Email Address</label>
                        <input type="email" id="email" name="email" class="w-full px-4 py-3 bg-gray-800 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter your email">
                    </div>
                    <div>
                        <label for="phone" class="block text-sm font-medium text-gray-200 mb-2">Phone Number</label>
                        <input type="tel" id="phone" name="phone" class="w-full px-4 py-3 bg-gray-800 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter your phone number">
                    </div>
                    <div>
                        <label for="booking-notes" class="block text-sm font-medium text-gray-200 mb-2">Optional Notes</label>
                        <textarea id="booking-notes" name="booking-notes" rows="3" class="w-full px-4 py-3 bg-gray-800 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., specific pickup instructions, flight number..."></textarea>
                    </div>
                </div>

                <div class="flex space-x-4 mt-8">
                    <button id="back-to-car-selection-btn" class="w-1/2 py-3 px-4 bg-gray-600 hover:bg-gray-700 rounded-lg text-white font-semibold">Back</button>
                    <button id="confirm-booking-btn" class="w-1/2 py-3 px-4 bg-green-600 hover:bg-green-700 rounded-lg text-white font-semibold">Send Booking Request</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBV4IgGYxyKog3A_L0lucUIeqoqEmi-TrA&libraries=places,directions&callback=initMap" async defer></script>

    <script>
        let map;
        let directionsRenderer;
        let tripDistanceInMiles = 0;
        let isAirportDropoff = false;

        function initMap() {
            const directionsService = new google.maps.DirectionsService();
            const geocoder = new google.maps.Geocoder();
            directionsRenderer = new google.maps.DirectionsRenderer();
            
            const formView = document.getElementById('form-view');
            const resultsView = document.getElementById('results-view');
            const carSelectionView = document.getElementById('car-selection-view');
            const bookingFormView = document.getElementById('booking-form-view');
            const bookingFormContainer = document.getElementById('booking-form-container');

            const calculateBtn = document.getElementById('calculate-btn');
            const policyAgreement = document.getElementById('policy-agreement'); // Checkbox element
            
            const chooseVehicleBtn = document.getElementById('choose-vehicle-btn');
            const startOverBtn = document.getElementById('start-over-btn');
            const backToRouteBtn = document.getElementById('back-to-route-btn');
            const carOptionsContainer = document.getElementById('car-options-container');

            const backToCarSelectionBtn = document.getElementById('back-to-car-selection-btn');
            const confirmBookingBtn = document.getElementById('confirm-booking-btn');
            const proceedToBookingBtn = document.getElementById('proceed-to-booking-btn');

            const autocompleteOptions = { componentRestrictions: { country: "GB" }, fields: ["formatted_address", "geometry", "icon", "name", "place_id", "types"], types: ["geocode", "establishment"] };
            new google.maps.places.Autocomplete(document.getElementById('pickup'), autocompleteOptions);
            new google.maps.places.Autocomplete(document.getElementById('dropoff'), autocompleteOptions);

            // Enable Submit button only when policy is agreed
            policyAgreement.addEventListener('change', () => {
                if (policyAgreement.checked) {
                    calculateBtn.disabled = false;
                    calculateBtn.classList.remove('bg-gray-500', 'cursor-not-allowed');
                    calculateBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                } else {
                    calculateBtn.disabled = true;
                    calculateBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    calculateBtn.classList.add('bg-gray-500', 'cursor-not-allowed');
                }
            });

            function calculateAndDisplayRoute() {
                const pickupAddress = document.getElementById('pickup').value;
                const dropoffAddress = document.getElementById('dropoff').value;
                const bookingTimeValue = document.getElementById('booking-time').value;
                if (!pickupAddress || !dropoffAddress || !bookingTimeValue) { 
                    document.getElementById('result').innerHTML = '<span class="text-yellow-400">Please fill in all fields to proceed.</span>';
                    return; 
                }
                if (!policyAgreement.checked) {
                    document.getElementById('result').innerHTML = '<span class="text-yellow-400">Please read and agree to the Ride Booking Policy to proceed.</span>';
                    return;
                }
                
                document.getElementById('result').textContent = 'Calculating...';
                calculateBtn.disabled = true;

                const request = { origin: pickupAddress, destination: dropoffAddress, travelMode: 'DRIVING', unitSystem: google.maps.UnitSystem.IMPERIAL };

                directionsService.route(request, (result, status) => {
                    calculateBtn.disabled = false;
                    if (status === 'OK') {
                        const destinationWaypoint = result.geocoded_waypoints[1];
                        isAirportDropoff = destinationWaypoint.types.includes('airport');
                        
                        formView.classList.add('hidden');
                        resultsView.classList.remove('hidden');

                        const leg = result.routes[0].legs[0];
                        tripDistanceInMiles = leg.distance.value / 1609.34;
                        
                        const bookingDate = new Date(bookingTimeValue);
                        const timeOptions = { weekday: 'short', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: false };
                        const formattedBookingTime = bookingDate.toLocaleDateString('en-GB', timeOptions);
                        
                        document.getElementById('booking-time-result').textContent = formattedBookingTime;
                        document.getElementById('pickup-result').textContent = leg.start_address;
                        document.getElementById('dropoff-result').textContent = leg.end_address;
                        document.getElementById('distance-result').textContent = leg.distance.text;
                        
                        if (!map) {
                           map = new google.maps.Map(document.getElementById("map"), { zoom: 7, center: leg.start_location, disableDefaultUI: true });
                        }
                        directionsRenderer.setMap(map);
                        directionsRenderer.setDirections(result);
                    } else {
                        document.getElementById('result').innerHTML = '<span class="text-yellow-400">Could not calculate distance. Please check your locations.</span>';
                    }
                });
            }
            
            function populateCarOptions() {
                carOptionsContainer.innerHTML = '';

                const carTypes = [
                    { name: 'Standard', description: 'Affordable, everyday rides', passengers: 4, luggage: 2, icon: 'fa-car', baseFare: 5.00, perMile: 2.00 },
                    { name: 'Executive', description: 'High-end cars with top-rated drivers', passengers: 4, luggage: 2, icon: 'fa-briefcase', baseFare: 8.00, perMile: 3.50, unavailable: true },
                    { name: 'MPV', description: 'For large groups up to 6', passengers: 6, luggage: 4, icon: 'fa-van-shuttle', baseFare: 6.00, perMile: 2.75, unavailable: true }
                ];

                carTypes.forEach(car => {
                    let price = car.baseFare + (car.perMile * tripDistanceInMiles);
                    if (isAirportDropoff) {
                        price += 10;
                    }

                    let priceHTML;
                    let cardClasses = "car-card bg-gray-800 p-4 rounded-lg flex items-center justify-between border-2 border-gray-700 transition-all";
                    
                    if (car.unavailable) {
                        cardClasses += " unavailable opacity-60";
                        priceHTML = `<p class="font-bold text-xl text-gray-500">Unavailable</p>`;
                    } else {
                        priceHTML = `<p class="font-bold text-xl">£${price.toFixed(2)}</p>`;
                    }

                    const carCard = `
                        <div class="${cardClasses}" 
                             data-car-name="${car.name}" 
                             data-price="${price.toFixed(2)}"
                             data-passengers="${car.passengers}"
                             data-luggage="${car.luggage}"
                             data-unavailable="${car.unavailable}">
                            <div class="flex items-center pointer-events-none">
                                <i class="fas ${car.icon} text-3xl text-gray-400 w-12 text-center"></i>
                                <div class="ml-4">
                                    <h4 class="font-bold text-lg">${car.name}</h4>
                                    <p class="text-sm text-gray-400">${car.description}</p>
                                    <p class="text-xs text-gray-300 mt-1">
                                        <i class="fas fa-user-group mr-1"></i> ${car.passengers} <i class="fas fa-suitcase ml-3 mr-1"></i> ${car.luggage}
                                    </p>
                                </div>
                            </div>
                            <div class="text-right pointer-events-none">
                                ${priceHTML}
                            </div>
                        </div>
                    `;
                    carOptionsContainer.insertAdjacentHTML('beforeend', carCard);
                });
            }
            
            // --- Event Listeners ---
            calculateBtn.addEventListener('click', calculateAndDisplayRoute);
            startOverBtn.addEventListener('click', () => { window.location.reload(); });
            backToRouteBtn.addEventListener('click', () => {
                carSelectionView.classList.add('hidden');
                resultsView.classList.remove('hidden');
            });
            backToCarSelectionBtn.addEventListener('click', () => {
                bookingFormView.classList.add('hidden');
                carSelectionView.classList.remove('hidden');
            });

            chooseVehicleBtn.addEventListener('click', () => {
                resultsView.classList.add('hidden');
                carSelectionView.classList.remove('hidden');
                proceedToBookingBtn.disabled = true;
                proceedToBookingBtn.classList.add('bg-gray-500', 'cursor-not-allowed');
                proceedToBookingBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                populateCarOptions();
            });

            carOptionsContainer.addEventListener('click', (e) => {
                const clickedCard = e.target.closest('.car-card');
                if (!clickedCard || clickedCard.dataset.unavailable === 'true') { return; }

                carOptionsContainer.querySelectorAll('.car-card').forEach(card => {
                    card.classList.remove('border-blue-500');
                    card.classList.add('border-gray-700');
                });

                clickedCard.classList.add('border-blue-500');
                clickedCard.classList.remove('border-gray-700');

                proceedToBookingBtn.disabled = false;
                proceedToBookingBtn.classList.remove('bg-gray-500', 'cursor-not-allowed');
                proceedToBookingBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                proceedToBookingBtn.dataset.carName = clickedCard.dataset.carName;
                proceedToBookingBtn.dataset.price = clickedCard.dataset.price;
                proceedToBookingBtn.dataset.passengers = clickedCard.dataset.passengers;
                proceedToBookingBtn.dataset.luggage = clickedCard.dataset.luggage;
            });

            proceedToBookingBtn.addEventListener('click', () => {
                const { carName, price, passengers, luggage } = proceedToBookingBtn.dataset;
                const pickupAddress = document.getElementById('pickup-result').textContent;
                const dropoffAddress = document.getElementById('dropoff-result').textContent;
                const bookingTime = document.getElementById('booking-time-result').textContent;

                document.getElementById('confirm-pickup').textContent = pickupAddress;
                document.getElementById('confirm-dropoff').textContent = dropoffAddress;
                document.getElementById('confirm-time').textContent = bookingTime;
                document.getElementById('confirm-vehicle').textContent = carName;
                document.getElementById('confirm-price').textContent = `£${price}`;
                document.getElementById('confirm-capacity').innerHTML = `
                    <i class="fas fa-user-group mr-1"></i> ${passengers}
                    <i class="fas fa-suitcase ml-3 mr-1"></i> ${luggage}
                `;

                carSelectionView.classList.add('hidden');
                bookingFormView.classList.remove('hidden');
            });

            confirmBookingBtn.addEventListener('click', () => {
                // --- 1. Form Validation ---
                const name = document.getElementById('full-name').value.trim();
                const email = document.getElementById('email').value.trim();
                const phone = document.getElementById('phone').value.trim();
                const notes = document.getElementById('booking-notes').value.trim();

                if (!name || !email || !phone) {
                    alert('Please fill in your name, email, and phone number.');
                    return;
                }
                if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                    alert('Please enter a valid email address.');
                    return;
                }
                if (!/^[\d\s-()]{10,}$/.test(phone)) {
                    alert('Please enter a valid phone number with at least 10 digits.');
                    return;
                }
                
                // --- 2. Assemble All Data for Submission ---
                const formData = {
                    name: name,
                    email: email,
                    phone: phone,
                    pickup: document.getElementById('confirm-pickup').textContent,
                    dropoff: document.getElementById('confirm-dropoff').textContent,
                    bookingTime: document.getElementById('confirm-time').textContent,
                    vehicle: document.getElementById('confirm-vehicle').textContent,
                    price: document.getElementById('confirm-price').textContent,
                    notes: notes,
                };
                
                // --- 3. Send Data to Google Apps Script ---
                const scriptURL = 'https://script.google.com/macros/s/AKfycbwfVffiAtPCZMRtAkWVyOQ3eR2QwHbe0mK_9u-6EBvWqy7yQJikdeo4ymK74qI_AFZCUw/exec';

                // Disable button to prevent multiple submissions
                confirmBookingBtn.disabled = true;
                confirmBookingBtn.textContent = 'Sending...';

                fetch(scriptURL, {
                  method: 'POST',
                  mode: 'no-cors', // This mode helps bypass browser CORS issues with Google Scripts
                  body: JSON.stringify(formData),
                  headers: { 'Content-Type': 'application/json' }
                })
                .catch(error => console.error('Error!', error.message));

                // Since 'no-cors' mode prevents reading the response, we assume success and show the message.
                // A short delay improves the user experience.
                setTimeout(() => {
                    bookingFormContainer.innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-phone-alt text-6xl text-blue-400 mb-4"></i>
                            <h2 class="text-3xl font-bold text-blue-400">Request Received!</h2>
                            <p class="text-gray-200 mt-4">Thank you, ${name}.</p>
                            <p class="text-gray-300 mt-2">A member of our team will call you at <strong>${phone}</strong> shortly to confirm your booking and arrange payment.</p>
                            <button onclick="window.location.reload()" class="w-full mt-8 py-3 px-4 bg-blue-600 hover:bg-blue-700 rounded-lg text-white font-semibold">Make Another Booking</button>
                        </div>
                    `;
                }, 1000); // 1-second delay 
            });
        }

        window.gm_authFailure = () => {
             document.getElementById('result').innerHTML = '<span class="text-yellow-400">Google Maps failed to load. Please check the API key.</span>';
        };
    </script>
</body>
</html>